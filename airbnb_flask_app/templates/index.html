{% extends 'base.html' %}

{% block title %}Home – Airbnb Clone{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    #map {
      height: 500px;
      width: 100%;
    }
  </style>
{% endblock %}

{% block content %}
  <h1 class="mb-4">Find your perfect stay</h1>
  <div id="map"></div>
  <hr />
  <h2>Property Listings</h2>
  <ul class="list-group">
    {% for listing in listings %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-1">{{ listing['name'] }}</h5>
        <small class="text-muted">{{ listing['location'] }} • {{ listing['type'] }}</small>
      </div>
      <span class="badge bg-primary rounded-pill">${{ listing['nightly_price'] }}</span>
    </li>
    {% endfor %}
  </ul>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    const propertyListings = {{ listings | tojson | safe }};

    function initMap() {
      // Default center (Toronto). If there are listings, center to the first one.
      const center = propertyListings.length ? { lat: propertyListings[0].lat, lng: propertyListings[0].lng } : { lat: 43.65107, lng: -79.347015 };
      const map = new google.maps.Map(document.getElementById('map'), {
        zoom: 4,
        center,
      });
      propertyListings.forEach((listing) => {
        const marker = new google.maps.Marker({
          position: { lat: listing.lat, lng: listing.lng },
          map: map,
          title: `${listing.name} ($${listing.nightly_price})`,
        });
        const infoWindow = new google.maps.InfoWindow({
          content: `<div><h6>${listing.name}</h6><p>${listing.location} - $${listing.nightly_price}/night</p></div>`,
        });
        marker.addListener('click', () => {
          infoWindow.open(map, marker);
        });
      });
    }
  </script>
  <!-- Load the Google Maps API -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap"></script>
{% endblock %}
